{% macro render_value(value) -%}
  {# 1) Single node link #}
  {% if value is mapping
        and value|length == 2
        and 'id' in value
        and 'title' in value -%}
    <form action="/explore" method="post" class="d-inline">
      <input type="hidden" name="node_id" value="{{ value['id'] }}">
      <button type="submit"
              class="btn btn-link p-0 align-baseline"
              formtarget="_blank">
        {{ value['title'] }}
      </button>
    </form>

  {# 2) Mapping‐of‐lists‐of‐node‐links #}
  {% elif value is mapping -%}
    {%- set all_tid = namespace(ok=True) -%}
    {%- for v in value.values() -%}
      {%- if not (
            v is sequence
            and v is not string
            and v|length > 0
            and v[0] is mapping
            and v[0].keys()|sort == ['id','title']
          ) -%}
        {%- set all_tid.ok = False -%}
      {%- endif -%}
    {%- endfor -%}

    {% if all_tid.ok -%}
      <ul class="list-unstyled mb-4">
        {%- for k, v in value.items() -%}
          <li>
            <strong>{{ k }}:</strong>
            <ul class="list-inline mb-0">
              {%- for item in v -%}
                <li class="list-inline-item">{{ render_value(item) }}</li>
              {%- endfor -%}
            </ul>
          </li>
        {%- endfor -%}
      </ul>

    {# 3) Generic mapping fallback with full‐width tables #}
    {% else -%}
      {%- for k, v in value.items() -%}
        {% if v is sequence and v and v[0] is mapping -%}
          <h5 class="mt-4">{{ k }}</h5>
          {{ render_value(v) }}
        {% else -%}
          <p><strong>{{ k }}:</strong> {{ render_value(v) }}</p>
        {% endif -%}
      {%- endfor -%}
    {%- endif -%}

  {# 4) Sequence of things #}
  {% elif value is sequence and value is not string -%}
    {# 4a) pure list of node‐links? #}
    {%- set is_tid = namespace(ok=True) -%}
    {%- for item in value -%}
      {%- if not (
            item is mapping
            and item|length == 2
            and 'id' in item
            and 'title' in item
          ) -%}
        {%- set is_tid.ok = False -%}
      {%- endif -%}
    {%- endfor -%}

    {% if is_tid.ok -%}
      <ul class="list-inline mb-4">
        {%- for item in value -%}
          <li class="list-inline-item">{{ render_value(item) }}</li>
        {%- endfor -%}
      </ul>

    {# 4b) table of dicts? #}
    {% elif value and value[0] is mapping -%}
      <table class="table table-sm table-bordered mb-4">
        <thead>
          <tr>
            {%- for col in value[0].keys() -%}
              <th>{{ col }}</th>
            {%- endfor -%}
          </tr>
        </thead>
        <tbody>
          {%- for row in value -%}
            <tr>
              {%- for col in value[0].keys() -%}
                <td>{{ render_value(row[col]) }}</td>
              {%- endfor -%}
            </tr>
          {%- endfor -%}
        </tbody>
      </table>

    {# 4c) generic list fallback #}
    {% else -%}
      <ul class="mb-4">
        {%- for item in value -%}
          <li>{{ render_value(item) }}</li>
        {%- endfor -%}
      </ul>
    {%- endif -%}

  {# 5) primitive fallback #}
  {% else -%}
    {{ value }}
  {%- endif %}
{%- endmacro %}


<div class="accordion" id="accordion-{{ section }}">
  {%- for metric_group, metrics in metric_data[section].items() -%}
    {%- if metric_group != 'description' -%}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ section }}-{{ loop.index }}">
          <button class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-{{ section }}-{{ loop.index }}"
                  aria-expanded="false"
                  aria-controls="collapse-{{ section }}-{{ loop.index }}">
            {{ metric_group }}
          </button>
        </h2>
        <div id="collapse-{{ section }}-{{ loop.index }}"
             class="accordion-collapse collapse"
             aria-labelledby="heading-{{ section }}-{{ loop.index }}"
             data-bs-parent="#accordion-{{ section }}">
          <div class="accordion-body">
            {%- if metrics['description'] -%}
              <p><em>{{ metrics['description'] }}</em></p>
            {%- endif -%}

            {%- for metric_type, value in metrics['metrics'].items() -%}
              {% if value is sequence and value and value[0] is mapping -%}
                <h4 class="mt-4">{{ metric_type }}</h4>
                {{ render_value(value) }}
              {% else -%}
                <dl class="row mb-4">
                  <dt class="col-sm-3">{{ metric_type }}</dt>
                  <dd class="col-sm-9">{{ render_value(value) }}</dd>
                </dl>
              {% endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- endif -%}
  {%- endfor -%}
</div>
